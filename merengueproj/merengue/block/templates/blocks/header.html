{% load i18n permissions_tags %}
{% ifhasperm "manage_portal" %}
<link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}merengue/css/render_blocks.css"/>
<link href="{{ MEDIA_URL }}merengue/css/shadowbox.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="{{ MEDIA_URL }}merengue/js/mootools.v1.11.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}merengue/js/shadowbox/shadowbox-mootools.js"></script>
<script type="text/javascript" src="{{ MEDIA_URL }}merengue/js/shadowbox/shadowbox.js"></script>
<script type="text/javascript">
// <![CDATA[

(function($) {
  if (!$.browser.msie || $.browser.version != '6.0') {
    $(document).ready(function() {
        var containers = $(".blockContainer:visible");

        function getBlocksOrder() {
            var order = [];
            containers.each(function() {
                var orderList = [];
                var place = $(this).children(".blockPlace").val();
                $(this).children(".block").children(".blockOrder").each(function() {
                    var val = $(this).val();
                    if (val) {
                        order.push(val +"#"+ place);
                    }
                });
            });
            return order.join(",");
        }

        function getBlocksContentRelated() {
            var order = [];
            containers.each(function() {
                var orderList = [];
                var place = $(this).children(".blockPlace").val();
                $(this).children(".block").children(".blockContentRelated").each(function() {
                    var val = $(this).val();
                    if (val) {
                        order.push(val +"#"+ place);
                    }
                });
            });
            return order.join(",");
        }

        function initBlockTools() {
            $(".block").each(function() {
                var dragAnchor, confAnchor, divTools, position;
                position = $(this).position();
                divTools = $("<div>");
                // creating block tools
                dragAnchor = $("<a>");
                dragAnchor.attr("href", "javascript:void(0)");
                dragAnchor.attr("title", "{% trans "Enable/disable blocks dragging" %}");
                dragAnchor.addClass("drag");
                dragAnchor.click(enableDragging);
                confAnchor = $("<a>");
                confAnchor.attr("href", "javascript:void(0)");
                confAnchor.attr("rel", "shadowbox");
                confAnchor.click(loadBlockConfiguration);
                confAnchor.addClass("configure");
                confAnchor.attr("title", "{% trans "Configure block" %}");
                // place all block tools
                divTools.append(dragAnchor);
                divTools.append(confAnchor);
                divTools.addClass("blockTools");
                divTools.css({"left": position.left - 20});
                divTools.css({"top": position.top});
                $(this).append(divTools);
                $(this).mouseenter(function() {
                    if($(this).attr("id")) {
                        $(this).children(".blockTools").stop(true, true).show();
                    }
                }).mouseleave(function() {
                    if($(this).attr("id")) {
                        $(this).children(".blockTools").delay(1000).fadeOut();
                    }
                });
            });
            // initialize shadowbox (if not initialized with multimedia slide)
            var mediaurl = '{{ MEDIA_URL }}';
            Shadowbox.init({
                assetUrl: mediaurl,
                loadingImage: mediaurl + 'multimedia/img/loading.gif',
                displayNav: true,
                skipSetup: true,
                displayClose: true,
                continuous: true
            });
        }

        function loadBlockConfiguration() {
            var blocks_index_url = '{% url blocks_index %}';
            var block = $(this).parents(".block");
            var block_id = block.children(".blockOrder").val();
            var block_title = block.children(".blockHiddenTitle").html();
            $.ajax({
                url: blocks_index_url + 'ajax/config/' + block_id,
                context: document.body,
                success: function(data){
                    Shadowbox.open({
                        content:    data,
                        type:       "html",
                        title:      block_title,
                        height:     600,
                        width:      500
                    });
                }
            });
            // when block config was loaded by AJAX (previous function)
            // we change usual submit by a AJAX submit (without refreshing browser)
            $('#config-block-form').live("submit", function(event) {
                event.preventDefault();
                $.ajax({
                    type: 'POST',
                    url: $(this).attr('action'),
                    data: $(this).serialize(),
                    success: function(data) {
                        $.ajax({
                            url: '.?render_block=' + block_id,
                            success: function(data) {
                                block.replaceWith(data);
                                Shadowbox.close();
                            }
                        });
                    }
                });
                return false;
            });

        }

        function enableDragging() {
            var container = $(this).parents(".blockContainer")[0];
            var containerType = "blocks";
            var validCSSClasses = ["contentblocks", "sectionblocks"];
            for (var i=0; i<validCSSClasses.length; i++) {
                if ($(container).hasClass(validCSSClasses[i])) {
                    containerType = validCSSClasses[i];
                    break;
                }
            }
            var validContainers = containers.filter("." + containerType);
            validContainers.each(function() {
                if ($(this).children().length < 2 || $(this).height() == 0) {
                    var child;
                    child = $("<div>");
                    child.html("Drag here");
                    child.addClass("blockDrag");
                    $(this).append(child);
                }
            });
            if (!validContainers.hasClass("blockContainerBorder")) {
                validContainers.addClass("blockContainerBorder");
                validContainers.sortable({
                    connectWith: '.blockContainer',
                    parent: 'document',
                    opacity: 0.6,
                    revert: true,
                    items: '.block',
                    helper: 'clone',
                    tolerance: 'pointer',
                    start: function(event, ui) {
                        $(".block .blockTools").hide();
                    },
                    stop: function(event, ui) {
                        $(".block .blockTools").hide();
                        disableDragging();
                        recalculatePosition(ui.item);
                        postNewOrder();
                    }
                });
                validContainers.disableSelection();
            } else {
                disableDragging();
            }
            return false;
        }

        function disableDragging() {
            containers.sortable("destroy");
            containers.removeClass("blockContainerBorder");
            containers.find(".blockDrag").remove();
        }

        function recalculatePosition(ui) {
            var position;
            position = $(ui).position();
            divTools = $(ui).children(".blockTools");
            divTools.css({"left": position.left - 20});
            divTools.css({"top": position.top});
        }

        function postNewOrder() {
            var newOrder = getBlocksOrder();
            var blockCntRltd = getBlocksContentRelated();
            $.ajax({
                url: "{% url blocks_reorder %}",
                type: "POST",
                data: ({new_order : newOrder, block_cnt_rltd: blockCntRltd}),
                dataType: "json",
                success: function(msg) {
                    // It's not necesary to alert the user
                },
                error: function() {
                    window.location = window.location;
                }
            });
        }

        initBlockTools();
    });
  }
})(jQuery);
// ]]>
</script>
{% endifhasperm %}
