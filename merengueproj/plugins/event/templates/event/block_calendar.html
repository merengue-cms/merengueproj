{% extends "block.html" %}

{% block blockbody %}
  <span id="eventsCalendar" class="calendar" style="font-size:73%;"></span>

<link href="{{ MEDIA_URL }}merengue/css/jquery-ui-1.8.css" rel="stylesheet" type="text/css"/>
<script src="{{ MEDIA_URL }}merengue/js/jquery-ui-1.8.min.js"></script>
<script language="javascript" src="{{ MEDIA_URL }}merengue/js/jquery.ui.datepicker-{{ LANGUAGE_CODE }}.js"></script>
<script language="javascript" src="{{ MEDIA_URL }}event/jquery.qtip.js"></script>

<script language="javascript" >
;(function($) {
    $(document).ready(function() {
        var datepickerOptions, eventDate;
        eventDate = {};
        {% for date, event in events_dic.items %}
        eventDate["{{ date }}"] = {
            'name': '{{ event.name|safe }}',
            'url': '{{ event.url }}'
        }
        {% endfor %}
        datepickerOptions = {
            changeMonth: true,
            changeYear: true,
            beforeShowDay: function(date) {
                var key;
                key = date.getFullYear() +"-"+ (date.getMonth() + 1) +"-"+ date.getDate();
                if (eventDate[key] && eventDate[key]['name'])
                {
                    return [true, "calendarEventDay", eventDate[key]['name']];
                }
                else
                {
                    return [false, "", ""];
                }
            },
            onSelect: function(dateText, inst) {
                var date, key;
                var date_splitted = dateText.split('/');
                date = new Date(parseInt(date_splitted[2]),
                                parseInt(date_splitted[1]) - 1,
                                parseInt(date_splitted[0]));
                key = date.getFullYear() +"-"+ (date.getMonth() + 1) +"-"+ date.getDate();
                if (eventDate[key]) {
                    window.location = eventDate[key]['url'];
                }
            },
            onChangeMonthYear: function(year, month, inst) {
                $.ajax({
                    url: "{% url events_calendar %}",
                    type: "GET",
                    data: ({month: month, year: year}),
                    dataType: "json",
                    success: function(events) {
                        eventDate = events;
                        $("#eventsCalendar").datepicker("refresh");
                        bind_days_tooltip();
                    }
                });
            }
        };
        $("#eventsCalendar").datepicker(datepickerOptions);
        bind_days_tooltip();
    });

    function bind_days_tooltip ()
    {
        $('.calendarEventDay[title]').qtip({
            position: {
               corner: {
                  target: 'topMiddle',
                  tooltip: 'bottomMiddle'
               }
            },
            hide: {fixed: true},
            style: {border: {radius: 5, color: 'black'}, tip: 'bottomMiddle'},
        });
    }

})(jQuery);
</script>

{% endblock %}

